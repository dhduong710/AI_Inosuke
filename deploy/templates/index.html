<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatInosuke</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div id="introPopup" class="popup hidden">
  <div class="popup-content intro-layout">

    <div class="intro-image">
      <img src="{{ url_for('static', filename='avatars/inosuke.png') }}" alt="Inosuke">
    </div>


    <div class="intro-text">
      <h2>ğŸ— Hashibira Inosuke</h2>
      <h3>NhÃ¢n váº­t trong bá»™ truyá»‡n <em>Thanh gÆ°Æ¡m diá»‡t quá»·</em></h3>
      <p><strong>Xuáº¥t thÃ¢n:</strong> Má»™t kiáº¿m sÄ© trong SÃ¡t quá»· Ä‘oÃ n, ná»•i báº­t vá»›i chiáº¿c máº·t náº¡ lá»£n rá»«ng.</p>
      <p><strong>TÃ­nh cÃ¡ch:</strong> Hung hÄƒng, nÃ³ng náº£y, luÃ´n thÃ­ch chiáº¿n Ä‘áº¥u. NÃ³i chuyá»‡n cá»™c lá»‘c, Æ°a thÃ¡ch thá»©c Ä‘á»‘i thá»§.</p>

      <hr style="margin: 18px 0; border: none; border-top: 1px solid #273627;">

      <h2>ğŸ¤– ChatInosuke</h3>
      <p>Chatbot AI nÃ y Ä‘Æ°á»£c xÃ¢y dá»±ng tá»« <strong>Qwen2.5-3B Instruct</strong>, tinh chá»‰nh vá»›i <strong>QLoRA 4-bit</strong>.<br></p>
      <p>Bá»™ dá»¯ liá»‡u Ä‘á»ƒ tinh chá»‰nh gá»“m <strong>hÆ¡n 9000 máº«u tá»± soáº¡n</strong>, giÃºp Chatbot pháº£n há»“i Ä‘Ãºng tÃ­nh cÃ¡ch.</p>
      <p>ÄÆ°á»£c phÃ¡t triá»ƒn bá»Ÿi <strong>DHD</strong>.</p>

      <div style="margin-top:18px; text-align:right;">
        <button id="nextIntroBtn">Tiáº¿p tá»¥c</button>
      </div>
    </div>
  </div>
</div>


<div id="avatarPopup" class="popup hidden">
  <div class="popup-content">
    <h2>Chá»n Avatar cá»§a báº¡n</h2>
    <div class="avatar-selection">
      <span class="avatar-option" data-avatar="ğŸ§‘">ğŸ§‘</span>
      <span class="avatar-option" data-avatar="ğŸ‘©">ğŸ‘©</span>
      <span class="avatar-option" data-avatar="ğŸ¤–">ğŸ¤–</span>
    </div>
    <button id="startChatBtn">Báº¯t Ä‘áº§u Chat</button>
  </div>
</div>


<div id="warningPopup" class="popup hidden">
  <div class="popup-content warning">
    <h2>âš ï¸ ChÆ°a chá»n Avatar</h2>
    <p>Báº¡n cáº§n chá»n má»™t avatar trÆ°á»›c khi báº¯t Ä‘áº§u chat!</p>
    <button id="closeWarningBtn">OK</button>
  </div>
</div>

<div id="modePopup" class="popup hidden">
  <div class="popup-content warning">
    <h2>â„¹ï¸ ThÃ´ng bÃ¡o</h2>
    <p>Hiá»‡n táº¡i, chatbot Ä‘ang á»Ÿ cháº¿ Ä‘á»™ nhÃ¢n váº­t, thá»ƒ hiá»‡n rÃµ tÃ­nh cÃ¡ch nhÃ¢n váº­t mÃ  khÃ´ng cÃ³ nhiá»u kiáº¿n thá»©c.</p>
    <p>Náº¿u báº¡n muá»‘n sá»­ dá»¥ng chatbot á»Ÿ cháº¿ Ä‘á»™ há»c thuáº­t thÃ¬ vui lÃ²ng liÃªn há»‡ vá»›i nhÃ  phÃ¡t triá»ƒn.</p>
    <p>VÃ¬ cháº¿ Ä‘á»™ há»c thuáº­t cÃ³ thá»ƒ máº¥t nhiá»u phÃºt Ä‘á»ƒ tráº£ lá»i vÃ  chá»‰ phá»¥c vá»¥ 1 ngÆ°á»i táº¡i má»™t thá»i Ä‘iá»ƒm.</p>
    <button class="closeWarningBtn" data-next="warningPopup1">OK</button>
  </div>
</div>


<div id="warningPopup1" class="popup hidden">
  <div class="popup-content warning">
    <h2>âš ï¸ Cáº£nh bÃ¡o</h2>
    <p>CÃ¡ch tráº£ lá»i sáº½ thÃ´ lá»—, hung hÄƒng vÃ  Ä‘Ã´i khi gay gáº¯t. HÃ£y cÃ¢n nháº¯c trÆ°á»›c khi vÃ o pháº§n trÃ² chuyá»‡n.</p>
    <p>ThÃ´ng tin cÃ³ thá»ƒ khÃ´ng chÃ­nh xÃ¡c, ná»™i dung mang tÃ­nh giáº£i trÃ­ lÃ  chá»§ yáº¿u.</p>
    <button class="closeWarningBtn" data-next="chat">TÃ´i Ä‘Ã£ hiá»ƒu</button>
  </div>
</div>


<div id="limitPopup" class="popup hidden">
  <div class="popup-content warning">
    <h2>âš ï¸ Há»‡ thá»‘ng báº­n</h2>
    <p>ÄÃ¢y lÃ  dá»± Ã¡n cÃ¡ nhÃ¢n nÃªn hiá»‡n chá»‰ phá»¥c vá»¥ <strong>1 ngÆ°á»i táº¡i má»™t thá»i Ä‘iá»ƒm</strong>.</p>
    <p>Náº¿u báº¡n tháº¥y thÃ´ng bÃ¡o nÃ y, vui lÃ²ng kiÃªn nháº«n chá» Ä‘áº¿n lÆ°á»£t. Xin cáº£m Æ¡n!</p>
    <button id="closeLimitBtn">OK</button>
  </div>
</div>



<div class="container">

  <div class="sidebar">
    <div class="sidebar-header">
      ğŸ— <span class="logo-text">ChatInosuke</span>
      <span class="info-btn" onclick="openIntro(false)" title="Giá»›i thiá»‡u">â„¹ï¸</span>
    </div>
    <button id="new-chat-btn" onclick="newChat()">+ Äoáº¡n chat má»›i</button>
    <div id="chat-list"></div>
  </div>


  <div class="chat-area">
    <div id="chat-box" class="chat-box"></div>
    <div class="input-area">
      <input id="user-input" type="text" placeholder="Nháº­p cÃ¢u há»i..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()">Gá»­i</button>
    </div>
  </div>
</div>

<script>
let chats = [];
let currentChatId = null;
let userAvatar = "ğŸ§‘";
let selectedAvatar = null;
let showAvatarAfterIntro = false;


function newChat() {
  const id = Date.now();
  chats.push({ id, name: "Äoáº¡n chat má»›i", messages: [] });
  currentChatId = id;
  renderChatList();
  renderMessages();
}

function openChat(id) {
  currentChatId = id;
  renderMessages();
  renderChatList();
}

function deleteChat(id) {
  chats = chats.filter(c => c.id !== id);
  if (currentChatId === id) currentChatId = chats.length ? chats[0].id : null;
  renderChatList();
  renderMessages();
}

function renameChat(id) {
  const chat = chats.find(c => c.id === id);
  if (!chat) return;
  const nameSpan = document.querySelector(`#chat-${id} .chat-name`);
  if (!nameSpan) return;

  nameSpan.contentEditable = true;
  nameSpan.focus();


  const range = document.createRange();
  range.selectNodeContents(nameSpan);
  range.collapse(false);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);

  nameSpan.onkeydown = (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      nameSpan.blur();
    }
  };
  nameSpan.onblur = () => {
    chat.name = nameSpan.innerText.trim() || "Äoáº¡n chat";
    nameSpan.contentEditable = false;
    nameSpan.onkeydown = null;
  };
}

function toggleMenu(id, event) {
  event.stopPropagation();
  const menu = document.getElementById(`menu-${id}`);
  document.querySelectorAll(".chat-menu").forEach(m => {
    if (m !== menu) m.style.display = "none";
  });
  menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

function closeMenu(id) {
  const menu = document.getElementById(`menu-${id}`);
  if (menu) menu.style.display = "none";
}

async function sendMessage() {
  const input = document.getElementById("user-input");
  const message = input.value.trim();
  if (!message) return;

  const chat = chats.find(c => c.id === currentChatId);
  if (!chat) return;

  chat.messages.push({ from: "user", text: message, avatar: userAvatar });
  input.value = "";
  renderMessages();

  chat.messages.push({ from: "loading", text: "..." });
  renderMessages();

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, avatar: userAvatar })
    });

    chat.messages = chat.messages.filter(m => m.from !== "loading");

    if (res.ok) {
      const data = await res.json();
      chat.messages.push({ from: "inosuke", text: data.response });
    } else {
      chat.messages.push({ from: "inosuke", text: "âš ï¸ lá»—i: khÃ´ng thá»ƒ láº¥y pháº£n há»“i tá»« mÃ¡y chá»§." });
    }
  } catch (err) {
    chat.messages = chat.messages.filter(m => m.from !== "loading");
    chat.messages.push({ from: "inosuke", text: "âš ï¸ lá»—i káº¿t ná»‘i: vui lÃ²ng thá»­ láº¡i sau." });
  }

  renderMessages();
}



function renderChatList() {
  const list = document.getElementById("chat-list");
  list.innerHTML = "";
  chats.forEach(c => {
    const div = document.createElement("div");
    div.className = "chat-item" + (c.id === currentChatId ? " active" : "");
    div.id = `chat-${c.id}`;
    div.onmouseleave = () => closeMenu(c.id);
    div.innerHTML = `
      <span class="chat-name" onclick="openChat(${c.id})">${c.name}</span>
      <span class="menu" onclick="toggleMenu(${c.id}, event)">â‹®</span>
      <div class="chat-menu" id="menu-${c.id}">
        <div onclick="renameChat(${c.id})">Äá»•i tÃªn</div>
        <div onclick="deleteChat(${c.id})">XÃ³a</div>
      </div>`;
    list.appendChild(div);
  });
}

function renderMessages() {
  const box = document.getElementById("chat-box");
  box.innerHTML = "";
  if (!currentChatId) return;
  const chat = chats.find(c => c.id === currentChatId);
  chat.messages.forEach(m => {
    const div = document.createElement("div");
    div.className = "message " + m.from;
    if (m.from === "loading") {
      div.innerHTML = `<div class="loading">ÄÃ¢y lÃ  dá»± Ã¡n cÃ¡ nhÃ¢n, triá»ƒn khai miá»…n phÃ­ nÃªn Inosuke tráº£ lá»i cháº­m (khoáº£ng 1 phÃºt). Mong báº¡n thÃ´ng cáº£m...</div>`;
    } else if (m.from === "user") {
      div.innerHTML = `<span class="text">${m.text}</span><span class="avatar">${m.avatar}</span>`;
    } else {
      div.innerHTML = `<span class="avatar"><img src="/static/avatars/inosuke.jpg" alt="inosuke"></span><span class="text">${m.text}</span>`;
    }
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}


function openIntro(wantAvatarNext = false) {
  showAvatarAfterIntro = !!wantAvatarNext;
  document.getElementById("introPopup").classList.remove("hidden");
}

document.getElementById("nextIntroBtn").onclick = () => {
  document.getElementById("introPopup").classList.add("hidden");
  if (showAvatarAfterIntro) {
    document.getElementById("avatarPopup").classList.remove("hidden");
  }
};

document.querySelectorAll(".avatar-option").forEach(opt => {
  opt.addEventListener("click", () => {
    document.querySelectorAll(".avatar-option").forEach(o => o.classList.remove("selected"));
    opt.classList.add("selected");
    selectedAvatar = opt.dataset.avatar;
  });
});

document.getElementById("startChatBtn").onclick = () => {
  if (!selectedAvatar) {
    document.getElementById("warningPopup").classList.remove("hidden");
    return;
  }
  userAvatar = selectedAvatar;
  document.getElementById("avatarPopup").classList.add("hidden");
  document.getElementById("warningPopup1").classList.remove("hidden");
};


document.getElementById("closeWarningBtn").onclick = () => {
  document.getElementById("warningPopup").classList.add("hidden");
};


document.querySelectorAll(".closeWarningBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const next = btn.dataset.next;
    btn.closest(".popup").classList.add("hidden");
    if (next === "chat") {
      newChat();
    } else if (next) {
      document.getElementById(next).classList.remove("hidden");
    }
  });
});

document.getElementById("closeLimitBtn").onclick = () => {
  document.getElementById("limitPopup").classList.add("hidden");
};

document.getElementById("startChatBtn").onclick = () => {
  if (!selectedAvatar) {
    document.getElementById("warningPopup").classList.remove("hidden");
    return;
  }
  userAvatar = selectedAvatar;
  document.getElementById("avatarPopup").classList.add("hidden");
  document.getElementById("modePopup").classList.remove("hidden"); 
};

window.onload = () => {
  openIntro(true);
};
</script>

</body>
</html>
